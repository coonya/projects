---
title: "Differential Expression - high LPS"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
params:
    bcbFile: "data/bcb_sub.rda"
    design: !r formula(~sheepID + timepointSampled)
    contrast: !r c("timepointSampled", 0, 24)
    alpha: 0.05
    lfc: 1
    outputDir: "."
---

Data was subset to only the high LPS samples and any samples without paired time points removed.

```{r setup, message=FALSE}
library(DESeq2)
library(bcbioRNASeq)

# Shared R Markdown settings
prepareRNASeqTemplate()
if (file.exists("setup.R")) {
    source("setup.R")Â 
}

# Directory paths
dataDir <- file.path(params$outputDir, "data")
countsDir <- file.path(params$outputDir, "results", "counts")
deDir <- file.path(params$outputDir, "results", "differential_expression", "highlps")

# Load bcbioRNASeq object
bcbName <- load(params$bcbFile)
bcb <- get(bcbName, inherits = FALSE)
bcb <- bcb[,which(colData(bcb)$lpsLevel=="high")]
mycoldata <- as.data.frame(colData(bcb))

# remove non paird samples
bcb <- bcb[, which(mycoldata$sheepID %in% mycoldata$sheepID[duplicated(mycoldata$sheepID)])]

# mod interesting groups
interestingGroups(bcb) <- "timepointSampled"
```

```{r header, child="_header.Rmd", eval=file.exists("_header.Rmd")}
```

```{r dds, results="hide"}
dds <- bcbio(bcb, "DESeqDataSet")
design(dds) <- params$design
dds <- DESeq(dds)
rld <- rlog(dds)
```

# Alpha level (FDR) cutoffs

Let's take a look at the number of genes we get with different false discovery rate (FDR) cutoffs. These tests subset *P* values that have been multiple test corrected using the Benjamini Hochberg (BH) method [@Benjamini:1995ws].

```{r alpha_summary, results="asis"}
alphaSummary(dds)
```

Tpo get a few hundred DE genes, I chose an adjusted p-value cutoff of 0.05.

# Results

```{r res}
# help("results", "DESeq2")
# For contrast argument as character vector:
#   1. Design matrix factor of interest.
#   2. Numerator for LFC (expt).
#   3. Denominator for LFC (control).
resUnshrunken <- results(
    dds,
    contrast = params$contrast,
    alpha = params$alpha)

# DESeqResults with shrunken log2 fold changes (LFC)
# help("lfcShrink", "DESeq2")
# Only `coef` or `contrast` can be specified, not both
# Use the correct `coef` number to modify from `resultsNames(dds)`
resShrunken <- lfcShrink(
    dds = dds,
    # coef = 2,
    contrast = params$contrast,
    res = resUnshrunken)

# Use shrunken LFC values by default
res <- resShrunken
res_highLPS <- res
saveData(res_highLPS, dir = dataDir)
```

We performed the analysis using a BH adjusted *P* value cutoff of `r params$alpha` and (sometimes) a log fold-change (LFC) ratio cutoff of `r params$lfc`. 

# Plots

## Mean average (MA)

An MA plot compares transformed counts on `M` (log ratio) and `A` (mean average) scales [@Yang:2002ty].

```{r plot_ma}
plotMA(res)
```

There are a good amount of DE genes.

## Volcano

A volcano plot compares significance (BH-adjusted *P* value) against fold change (log2) [@Cui:2003kh; @Li:2014fv]. Genes in the green box with text labels have an adjusted *P* value are likely to be the top candidate genes of interest.

I plotted these in two ways, the first gives you a sense of the proportion of genes that are within the adjusted p-value and lfc cutoffs. The second is more visually appealing and doesn't have a hard cutoff on the y-axis.

```{r plot_volcano}
plotVolcano(res)

myresults <- as.data.frame(res)
myresults <- myresults %>% mutate(., DE=ifelse((padj<params$alpha) & abs(log2FoldChange)>params$lfc, "yes", "no"))
ggplot(myresults, aes(x=log2FoldChange, y=-log10(padj), color=DE))+geom_point( alpha=0.6)+scale_color_manual( values=c("darkgrey", "purple"))
```


## Heatmap

This plot shows only differentially expressed genes on a per-sample basis. We have scaled the data by row and used the `ward.D2` method for clustering [@WardJr:1963eu].

Once again, I plotted it two ways. The first plots the expression values for all DE genes (here only defined by their adjusted p-value) and the second, the top 50 DE genes (as sorted by adjusted p-value). The second plot lets us see some of the individual gene names. 

```{r plot_deg_heatmap}
plotDEGHeatmap(res, counts = rld)

top50res <-  subset(res, padj<0.05) %>% .[order(.$padj),] %>% .[1:50,]
top50gene <- row.names(top50res)

plotHeatmap(bcb, top50gene, normalized="rlog", title="Top 50 Differentially Expressed Genes" )
```

# Differentially expressed genes (DEG) summary

```{r results_tables, results="asis"}
resTbl <- resultsTables(
    res,
    lfc = params$lfc,
    write = TRUE,
    summary = TRUE,
    headerLevel = 3,
    dir = deDir)
```


# Top tables

Only the top up- and down-regulated genes (arranged by log2 fold change) are shown.

DEG tables are sorted by BH-adjusted P value, and contain the following columns:

- `ensgene`: [Ensembl][] gene identifier.
- `baseMean`: Mean of the normalized counts per gene for all samples.
- `log2FoldChange`: log2 fold change.
- `lfcSE`: log2 standard error.
- `stat`: Wald statistic.
- `pvalue`: Walt test *P* value.
- `padj`: BH adjusted Wald test *P* value (corrected for multiple comparisons; aka FDR).
- `externalGeneName`: [Ensembl][] name (a.k.a. symbol).
- `description`: [Ensembl][] description.
- `geneBiotype`: [Ensembl][] biotype (e.g. `protein_coding`).

```{r top_tables, results="asis"}
topTables(resTbl)
```

# File downloads

The results are saved as gzip-compressed comma separated values (CSV). Gzip compression is natively supported on [macOS][] and Linux-based operating systems. If you're running Windows, we recommend installing [7-Zip][]. CSV files can be opened in [Excel][] or [RStudio][].

## Count matrices

- [`normalizedCounts.csv.gz`](`r file.path(countsDir, "normalizedCounts.csv.gz")`): Use to evaluate individual genes and/or generate plots. These counts are normalized for the variation in sequencing depth across samples.
- [`tpm.csv.gz`](`r file.path(countsDir, "tpm.csv.gz")`): Transcripts per million, scaled by length and also suitable for plotting.
- [`rawCounts.csv.gz`](`r file.path(countsDir, "rawCounts.csv.gz")`): Only use to perform a new differential expression analysis. These counts will vary across samples due to differences in sequencing depth, and have not been normalized. Do not use this file for plotting genes.

## Differentially expressed genes (DEG)

All files can be found in this [folder](./results/differential_expression/). 

\*all.csv.gz - statistics and annotations for all genes       
\*deg.csv.gz - statistics and annotations for differentially expressed genes
\*deg_lfc_down.csv.gz - statistics and annotations for differentially expressed genes that are up in first listed sample class (i.e. if filename is 1_vs_2, genes are more highly expressed in 1)
\*deg_lfc_up.csv.gz - statistics and annotations for differentially expressed genes that are down in first listed sample class (i.e. if filename is 1_vs_2, genes are more highly expressed in 1)


```{r footer, child="_footer.Rmd", eval=file.exists("_footer.Rmd")}
```
